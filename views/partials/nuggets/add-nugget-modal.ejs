<div
  id="createNuggetModal"
  class="fixed inset-0 z-50 hidden bg-black/50 p-3 sm:p-6"
>
  <!-- Backdrop click area + center wrapper -->
  <div class="flex h-full w-full items-center justify-center">
    <!-- Modal panel -->
    <div
      class="w-full max-w-2xl overflow-hidden rounded-2xl bg-white shadow-xl"
      role="dialog"
      aria-modal="true"
      aria-labelledby="createNuggetTitle"
    >
      <!-- ✅ Sticky header -->
      <div
        class="sticky top-0 z-10 flex items-center justify-between border-b border-gray-100 bg-white px-5 py-4"
      >
        <h3 id="createNuggetTitle" class="text-base font-semibold text-gray-800">
          Create Nugget
        </h3>

        <button
          type="button"
          class="inline-flex h-9 w-9 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700"
          onclick="closeCreateNuggetModal()"
          aria-label="Close modal"
        >
          ×
        </button>
      </div>

      <!-- ✅ Scrollable content -->
      <div class="max-h-[80vh] overflow-y-auto px-5 py-4">
        <form
          id="createNuggetForm"
          action="/nuggets"
          method="POST"
          class="space-y-3 text-xs"
        >
          <!-- Optional Title -->
          <div>
            <label class="mb-1 block font-medium text-gray-700">
              Title <span class="text-gray-400">(optional)</span>
            </label>
            <input
              id="nuggetTitle"
              type="text"
              name="title"
              maxlength="80"
              placeholder="e.g. Morning Focus"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-[var(--color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
              oninput="updateNuggetCount('nuggetTitle','titleCount',80)"
            />
            <div class="mt-1 flex items-center justify-between">
              <p class="text-[11px] text-gray-500">
                3–80 characters (if provided).
              </p>
              <p class="text-[11px] text-gray-500">
                <span id="titleCount">0</span>/80
              </p>
            </div>
          </div>

          <!-- ✅ Body (Textarea only) -->
          <div>
            <label class="mb-1 block font-medium text-gray-700">
              Body <span class="text-red-500">*</span>
            </label>

            <textarea
              id="nuggetBody"
              name="body"
              rows="6"
              maxlength="280"
              placeholder="Write a short nugget (10–280 characters)..."
              class="w-full resize-none rounded-lg border border-gray-300 px-3 py-2 leading-relaxed focus:border-[var(--color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
              oninput="updateNuggetCount('nuggetBody','bodyCount',280); hideBodyError();"
              required
            ></textarea>

            <div class="mt-1 flex items-center justify-between">
              <p class="text-[11px] text-gray-500">
                10–280 characters. Plain text only.
              </p>
              <p class="text-[11px] text-gray-500">
                <span id="bodyCount">0</span>/280
              </p>
            </div>

            <p id="bodyError" class="mt-1 hidden text-[11px] text-red-600">
              Body must be 10–280 characters.
            </p>
          </div>

          <!-- Nugget Type (Required) -->
          <div>
            <label class="mb-1 block font-medium text-gray-700">
              Audience <span class="text-red-500">*</span>
            </label>
            <select
              id="nuggetType"
              name="nuggetType"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-[var(--color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
              required
            >
              <option value="" disabled selected>Select audience</option>
              <option value="GENERAL">GENERAL (Everyone)</option>
              <option value="SINGLE">SINGLE</option>
              <option value="MARRIED">MARRIED</option>
              <option value="PARENT">PARENT</option>
            </select>
            <p class="mt-1 text-[11px] text-gray-500">
              Use <span class="font-semibold">GENERAL</span> to reach everyone.
            </p>
          </div>

          <!-- Publish At (Optional) -->
          <div>
            <label class="mb-1 block font-medium text-gray-700">
              Publish At <span class="text-gray-400">(optional)</span>
            </label>

            <input
              id="publishAtLocal"
              type="datetime-local"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:border-[var(--color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            />

            <!-- hidden ISO value actually submitted -->
            <input id="publishAt" name="publishAt" type="hidden" value="" />

            <div class="mt-1 flex items-center justify-between">
              <p class="text-[11px] text-gray-500">
                If set, we’ll schedule this nugget. If empty, it’s available
                immediately.
              </p>
              <button
                type="button"
                class="text-[11px] font-semibold text-[var(--color-primary)] hover:opacity-90"
                onclick="clearPublishAt()"
              >
                Clear
              </button>
            </div>
          </div>

          <!-- ✅ Sticky footer actions -->
          <div
            class="sticky bottom-0 z-10 -mx-5 mt-4 border-t border-gray-100 bg-white px-5 py-3"
          >
            <div
              class="flex flex-col-reverse gap-2 sm:flex-row sm:justify-end"
            >
              <button
                type="button"
                class="w-full rounded-md border border-gray-300 px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 sm:w-auto"
                onclick="closeCreateNuggetModal()"
              >
                Cancel
              </button>

              <button
                id="createNuggetSubmitBtn"
                type="submit"
                class="inline-flex w-full items-center justify-center gap-2 rounded-md bg-[var(--color-primary)] px-4 py-2 text-xs font-semibold text-white hover:bg-[var(--color-primary-dark)] disabled:cursor-not-allowed disabled:opacity-60 sm:w-auto"
              >
                <span id="createNuggetSubmitText">Create nugget</span>

                <svg
                  id="createNuggetSubmitSpinner"
                  class="hidden h-4 w-4 animate-spin text-white"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function openCreateNuggetModal() {
    const modal = document.getElementById("createNuggetModal");
    if (!modal) return;

    modal.classList.remove("hidden");
    modal.classList.add("block");

    updateNuggetCount("nuggetTitle", "titleCount", 80);
    updateNuggetCount("nuggetBody", "bodyCount", 280);
    hideBodyError();

    window.__createNuggetEscHandler = (e) => {
      if (e.key === "Escape") closeCreateNuggetModal();
    };
    document.addEventListener("keydown", window.__createNuggetEscHandler);
  }

  function closeCreateNuggetModal() {
    const modal = document.getElementById("createNuggetModal");
    if (!modal) return;

    modal.classList.add("hidden");
    modal.classList.remove("block");

    const form = document.getElementById("createNuggetForm");
    if (form) form.reset();

    const publishIso = document.getElementById("publishAt");
    if (publishIso) publishIso.value = "";

    const titleCount = document.getElementById("titleCount");
    const bodyCount = document.getElementById("bodyCount");
    if (titleCount) titleCount.textContent = "0";
    if (bodyCount) bodyCount.textContent = "0";
    hideBodyError();

    const btn = document.getElementById("createNuggetSubmitBtn");
    const text = document.getElementById("createNuggetSubmitText");
    const spinner = document.getElementById("createNuggetSubmitSpinner");
    if (btn && text && spinner) {
      btn.disabled = false;
      spinner.classList.add("hidden");
      text.textContent = "Create nugget";
    }

    if (window.__createNuggetEscHandler) {
      document.removeEventListener("keydown", window.__createNuggetEscHandler);
      window.__createNuggetEscHandler = null;
    }
  }

  // Backdrop click close
  (function bindCreateNuggetBackdropClose() {
    const modal = document.getElementById("createNuggetModal");
    if (!modal) return;

    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeCreateNuggetModal();
    });
  })();

  function updateNuggetCount(inputId, countId, max) {
    const input = document.getElementById(inputId);
    const count = document.getElementById(countId);
    if (!input || !count) return;

    const len = (input.value || "").length;
    count.textContent = String(len);

    if (len >= max) {
      count.classList.add("text-red-600");
      count.classList.remove("text-gray-500");
    } else {
      count.classList.remove("text-red-600");
      count.classList.add("text-gray-500");
    }
  }

  function showBodyError(msg) {
    const el = document.getElementById("bodyError");
    if (!el) return;
    el.textContent = msg || "Body must be 10–280 characters.";
    el.classList.remove("hidden");
  }

  function hideBodyError() {
    const el = document.getElementById("bodyError");
    if (!el) return;
    el.classList.add("hidden");
  }

  function clearPublishAt() {
    const local = document.getElementById("publishAtLocal");
    const iso = document.getElementById("publishAt");
    if (local) local.value = "";
    if (iso) iso.value = "";
  }

  function localToIsoString(localValue) {
    if (!localValue) return "";
    const d = new Date(localValue);
    if (Number.isNaN(d.getTime())) return "";
    return d.toISOString();
  }

  function sanitizeStringValue(v) {
    return typeof v === "string" ? v.replace(/\s+/g, " ").trim() : v;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("createNuggetForm");
    const submitBtn = document.getElementById("createNuggetSubmitBtn");
    const submitText = document.getElementById("createNuggetSubmitText");
    const submitSpinner = document.getElementById("createNuggetSubmitSpinner");

    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const titleEl = document.getElementById("nuggetTitle");
      const bodyEl = document.getElementById("nuggetBody");
      const typeEl = document.getElementById("nuggetType");
      const publishLocalEl = document.getElementById("publishAtLocal");

      const bodyPlain = (bodyEl?.value || "").replace(/\s+/g, " ").trim();
      if (bodyPlain.length < 10 || bodyPlain.length > 280) {
        showBodyError("Body must be between 10 and 280 characters.");
        return;
      }

      const isoPublishAt = localToIsoString(publishLocalEl ? publishLocalEl.value : "");
      const title = titleEl ? sanitizeStringValue(titleEl.value) : "";

      const payload = {
        ...(title ? { title } : {}),
        body: bodyPlain,
        nuggetType: typeEl ? typeEl.value : "",
        ...(isoPublishAt ? { publishAt: isoPublishAt } : {}),
      };

      if (!payload.nuggetType) {
        alert("Please select an audience (nuggetType).");
        return;
      }

      // Loading state
      submitBtn.disabled = true;
      submitSpinner.classList.remove("hidden");
      submitText.textContent = "Creating...";

      try {
        const res = await fetch(form.action, {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          let msg = "Error creating nugget.";
          try {
            const data = await res.json();
            msg = Array.isArray(data.message)
              ? data.message.join(", ")
              : data.message || msg;
          } catch (_) {}
          alert(msg);

          submitBtn.disabled = false;
          submitSpinner.classList.add("hidden");
          submitText.textContent = "Create nugget";
          return;
        }

        closeCreateNuggetModal();
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert("Something went wrong.");

        submitBtn.disabled = false;
        submitSpinner.classList.add("hidden");
        submitText.textContent = "Create nugget";
      }
    });
  });
</script>
