<div
  id="deleteTaskModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-4"
>
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-sm p-6 text-xs">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold text-red-600">Delete Task</h3>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 text-lg leading-none"
        onclick="closeDeleteTaskModal()"
      >
        Ã—
      </button>
    </div>

    <p class="text-[11px] text-gray-700 mb-2">
      Are you sure you want to delete this task from the challenge?
    </p>
    <p
      class="text-[11px] font-semibold text-gray-900 mb-4"
      id="deleteTaskTitle"
    ></p>

    <form id="deleteTaskForm">
      <input type="hidden" name="taskId" id="deleteTaskId" />
      <input type="hidden" name="challengeId" id="deleteTaskChallengeId" />

      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="px-3 py-2 rounded-lg border border-gray-300 text-[11px] text-gray-700 hover:bg-gray-50"
          onclick="closeDeleteTaskModal()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-3 py-2 rounded-lg bg-red-600 text-[11px] text-white font-semibold hover:bg-red-700"
        >
          Delete
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function openDeleteTaskModal(button) {
    const taskId = button.dataset.taskId;
    const challengeId = button.dataset.challengeId;
    const title = button.dataset.taskTitle || '';

    document.getElementById('deleteTaskId').value = taskId;
    document.getElementById('deleteTaskChallengeId').value =
      challengeId || '';
    document.getElementById('deleteTaskTitle').innerText = title;

    const modal = document.getElementById('deleteTaskModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeDeleteTaskModal() {
    const modal = document.getElementById('deleteTaskModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const deleteTaskForm = document.getElementById('deleteTaskForm');
    if (!deleteTaskForm) return;

    deleteTaskForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const taskId = document.getElementById('deleteTaskId').value;
      const challengeId = document.getElementById('deleteTaskChallengeId').value;
      if (!taskId || !challengeId) {
        alert('Task ID or Challenge ID is missing.');
        return;
      }

      const submitBtn =
        deleteTaskForm.querySelector('button[type="submit"]');
      const originalText = submitBtn ? submitBtn.textContent : null;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Deleting...';
      }

      try {
        const res = await fetch(`/challenges/${challengeId}/tasks/${taskId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!res.ok) {
          let msg = 'Failed to delete task.';
          try {
            const err = await res.json();
            if (err && err.message) {
              msg = Array.isArray(err.message)
                ? err.message.join('\n')
                : err.message;
            }
          } catch (_) {}
          alert(msg);
          return;
        }

        closeDeleteTaskModal();
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'An unexpected error occurred.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    });
  });
</script>
