<!-- Update Challenge Modal (NO tasks + Rich Text Description via Quill + Cover Image Upload + coverImageUrl in payload) -->
<div
  id="updateChallengeModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-4"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-6 text-xs overflow-hidden flex flex-col max-h-[90vh]"
    role="dialog"
    aria-modal="true"
    aria-labelledby="updateChallengeTitle"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
      <h3 id="updateChallengeTitle" class="text-base font-semibold text-gray-800">
        Update Challenge
      </h3>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 text-xl leading-none"
        onclick="closeUpdateChallengeModal()"
        aria-label="Close modal"
      >
        ×
      </button>
    </div>

    <!-- Scrollable Content -->
    <div class="overflow-y-auto pr-2 flex-1 custom-scrollbar space-y-5">
      <form id="updateChallengeForm" class="space-y-5">
        <input type="hidden" name="id" id="updateChallengeId" />

        <!-- BASIC INFO -->
        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Title
          </label>
          <input
            type="text"
            name="title"
            id="updateChallengeTitleInput"
            required
            minlength="3"
            maxlength="100"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
          />
        </div>

        <!-- ✅ Cover Image Upload -->
        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Cover image (optional)
          </label>
          <input
            type="file"
            name="coverUrl"
            id="updateChallengeCoverUrl"
            accept="image/png,image/jpeg,image/webp"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
          />
          <p class="text-[11px] text-gray-500 mt-1">
            Upload a new image to replace the current cover.
          </p>

          <!-- ✅ keep current coverImageUrl (from DB) so it can be included in payload if user doesn't upload -->
          <input
            type="hidden"
            name="coverImageUrl"
            id="updateChallengeCoverImageUrl"
          />
        </div>

        <!-- ✅ Description (Rich Text - Quill) -->
        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Description
          </label>

          <div
            id="updateChallengeDescriptionEditor"
            class="bg-white border border-gray-300 rounded-lg"
            style="min-height: 160px"
          ></div>

          <!-- Hidden textarea that gets serialized -->
          <textarea
            id="updateChallengeDescriptionHtml"
            name="descriptionHtml"
            class="hidden"
          ></textarea>

          <p class="text-[11px] text-gray-500 mt-1">
            Supports formatting, lists, and links.
          </p>
        </div>

        <!-- COMMUNITY & STATUS -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Community
            </label>
            <select
              name="community"
              id="updateChallengeCommunity"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="">Select</option>
              <option value="SINGLE">Single</option>
              <option value="MARRIED">Married</option>
              <option value="PARENT">Parent</option>
            </select>
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Status
            </label>
            <select
              name="status"
              id="updateChallengeStatus"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="ACTIVE">Active</option>
              <option value="DRAFT">Draft</option>
              <option value="ARCHIVED">Archived</option>
            </select>
          </div>
        </div>

        <!-- VISIBILITY & FREQUENCY -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Visibility
            </label>
            <select
              name="visibility"
              id="updateChallengeVisibility"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="PUBLIC">Public</option>
              <option value="COMMUNITY_ONLY">Community Only</option>
            </select>
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Frequency
            </label>
            <select
              name="frequency"
              id="updateChallengeFrequency"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="DAILY">Daily</option>
              <option value="WEEKLY">Weekly</option>
              <option value="MIXED">Mixed</option>
            </select>
          </div>
        </div>

        <!-- DURATION & BADGE -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Duration (days)
            </label>
            <input
              type="number"
              name="durationDays"
              id="updateChallengeDurationDays"
              min="1"
              max="365"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            />
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Completion badge code (optional)
            </label>
            <input
              type="text"
              name="completionBadgeCode"
              id="updateChallengeCompletionBadgeCode"
              maxlength="50"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            />
          </div>
        </div>

        <!-- Optional checkbox -->
        <div>
          <label class="inline-flex items-center gap-2 text-[11px] text-gray-700">
            <input
              type="checkbox"
              id="updateChallengeRequireDualConfirmation"
              name="requireDualConfirmation"
              value="true"
              class="rounded border-gray-300 text-[var(--color-primary)] focus:ring-[var(--color-primary)]"
            />
            Require dual confirmation (married)
          </label>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="mt-4 flex justify-end gap-2 flex-shrink-0">
      <button
        type="button"
        class="px-3 py-2 rounded-lg border border-gray-300 text-[11px] text-gray-700 hover:bg-gray-50"
        onclick="closeUpdateChallengeModal()"
      >
        Cancel
      </button>
      <button
        type="submit"
        form="updateChallengeForm"
        class="px-3 py-2 rounded-lg bg-[var(--color-primary)] text-[11px] text-white font-semibold hover:bg-[var(--color-primary-dark)]"
      >
        Save changes
      </button>
    </div>
  </div>
</div>

<style>
  .custom-scrollbar::-webkit-scrollbar { width: 6px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #c6c6c6; border-radius: 10px; }
</style>

<script>
  /* ✅ Quill instance for update challenge description */
  let updateChallengeDescriptionQuill;

  function ensureUpdateChallengeQuill() {
    if (updateChallengeDescriptionQuill) return;

    const editorEl = document.getElementById("updateChallengeDescriptionEditor");
    if (!editorEl) return;

    updateChallengeDescriptionQuill = new Quill("#updateChallengeDescriptionEditor", {
      theme: "snow",
      placeholder: "Update the challenge description...",
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ["bold", "italic", "underline"],
          [{ list: "ordered" }, { list: "bullet" }],
          ["link"],
          ["clean"],
        ],
      },
    });
  }

  async function openUpdateChallengeModal(button) {
    const id = button.getAttribute("data-challenge-id");
    if (!id) return;

    const modal = document.getElementById("updateChallengeModal");
    const form = document.getElementById("updateChallengeForm");

    form.reset();

    // clear file input
    const fileInput = document.getElementById("updateChallengeCoverUrl");
    if (fileInput) fileInput.value = "";

    modal.classList.remove("hidden");
    modal.classList.add("flex");

    ensureUpdateChallengeQuill();

    try {
      const res = await fetch(`/challenges/single/${id}`);
      if (!res.ok) throw new Error(`Failed to fetch challenge (status ${res.status})`);

      const json = await res.json();
      const challenge = json.data || json;

      populateUpdateChallengeModal(challenge);
    } catch (err) {
      console.error(err);
      alert(err.message || "Failed to load challenge details.");
      closeUpdateChallengeModal();
    }
  }

  function populateUpdateChallengeModal(challenge) {
    document.getElementById("updateChallengeId").value = challenge.id;
    document.getElementById("updateChallengeTitleInput").value = challenge.title || "";

    document.getElementById("updateChallengeCommunity").value = challenge.community || "";
    document.getElementById("updateChallengeStatus").value = challenge.status || "";
    document.getElementById("updateChallengeVisibility").value = challenge.visibility || "";
    document.getElementById("updateChallengeFrequency").value = challenge.frequency || "";

    document.getElementById("updateChallengeDurationDays").value =
      typeof challenge.durationDays === "number" ? challenge.durationDays : "";

    document.getElementById("updateChallengeCompletionBadgeCode").value =
      challenge.completionBadgeCode || "";

    const dual = document.getElementById("updateChallengeRequireDualConfirmation");
    if (dual) dual.checked = !!challenge.requireDualConfirmation;

    // ✅ store existing coverImageUrl
    const coverImageUrlEl = document.getElementById("updateChallengeCoverImageUrl");
    if (coverImageUrlEl) {
      coverImageUrlEl.value = challenge.coverImageUrl || challenge.coverUrl || "";
    }

    // ✅ Quill content
    const html = challenge.descriptionHtml || challenge.description || "";
    if (updateChallengeDescriptionQuill) {
      if (!html) updateChallengeDescriptionQuill.setContents([]);
      else updateChallengeDescriptionQuill.clipboard.dangerouslyPasteHTML(html);
    }

    // keep hidden textarea synced
    const hidden = document.getElementById("updateChallengeDescriptionHtml");
    if (hidden) hidden.value = html || "";
  }

  function closeUpdateChallengeModal() {
    const modal = document.getElementById("updateChallengeModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");

    if (updateChallengeDescriptionQuill) updateChallengeDescriptionQuill.setContents([]);

    const hidden = document.getElementById("updateChallengeDescriptionHtml");
    if (hidden) hidden.value = "";

    const coverImageUrlEl = document.getElementById("updateChallengeCoverImageUrl");
    if (coverImageUrlEl) coverImageUrlEl.value = "";

    const fileInput = document.getElementById("updateChallengeCoverUrl");
    if (fileInput) fileInput.value = "";
  }

  function buildUpdateChallengeFormData() {
    const form = document.getElementById("updateChallengeForm");

    const fd = new FormData();

    const getVal = (name) => {
      const el = form.querySelector(`[name="${name}"]`);
      return el ? String(el.value || "").trim() : "";
    };

    // Basic fields
    fd.append("title", getVal("title"));
    fd.append("community", getVal("community"));
    fd.append("status", getVal("status"));
    fd.append("visibility", getVal("visibility"));
    fd.append("frequency", getVal("frequency"));

    // numbers
    const durationDays = parseInt(getVal("durationDays"), 10);
    if (!Number.isNaN(durationDays)) fd.append("durationDays", String(durationDays));

    // optional
    const badge = getVal("completionBadgeCode");
    if (badge) fd.append("completionBadgeCode", badge);

    const dualCheckbox = document.getElementById("updateChallengeRequireDualConfirmation");
    if (dualCheckbox) fd.append("requireDualConfirmation", dualCheckbox.checked ? "true" : "false");

    // ✅ Quill → HTML (rich text)
    let html = "";
    if (updateChallengeDescriptionQuill) {
      html = updateChallengeDescriptionQuill.root?.innerHTML || "";
      if (html === "<p><br></p>" || html.trim() === "") html = "";
    }

    if (html) {
      // fd.append("descriptionHtml", html);
      fd.append("description", html); // if your backend expects description
    }

    // ✅ Existing cover URL (if no new file uploaded, backend can keep it)
    const existingUrl = getVal("coverImageUrl");
    if (existingUrl) fd.append("coverImageUrl", existingUrl);

    // ✅ File (binary)
    const fileInput = document.getElementById("updateChallengeCoverUrl");
    if (fileInput?.files?.[0]) {
      fd.append("coverUrl", fileInput.files[0]); // MUST match FileInterceptor('coverUrl')
    }

    return fd;
  }

  document.addEventListener("DOMContentLoaded", function () {
    ensureUpdateChallengeQuill();

    const form = document.getElementById("updateChallengeForm");
    if (!form) return;

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const id = document.getElementById("updateChallengeId").value;
      if (!id) {
        alert("Challenge ID is missing.");
        return;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn ? submitBtn.textContent : "Save changes";

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Saving...";
      }

      try {
        const formData = buildUpdateChallengeFormData();

        const res = await fetch(`/challenges/update-challenge/${id}`, {
          method: "PUT",
          body: formData, // ✅ multipart/form-data
          // ❌ DO NOT set Content-Type
        });

        if (!res.ok) {
          let msg = "Failed to update challenge.";
          try {
            const errJson = await res.json();
            if (errJson?.message) {
              msg = Array.isArray(errJson.message)
                ? errJson.message.join("\n")
                : errJson.message;
            }
          } catch (_) {}
          alert(msg);
          return;
        }

        closeUpdateChallengeModal();
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err?.message || "An unexpected error occurred.");
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    });
  });
</script>
