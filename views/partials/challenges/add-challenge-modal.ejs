<div
  id="addChallengeModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-4"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-6 text-xs overflow-hidden flex flex-col max-h-[90vh]"
  >
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
      <h3 class="text-base font-semibold text-gray-800">Add Challenge</h3>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 text-xl leading-none"
        onclick="closeAddChallengeModal()"
      >
        √ó
      </button>
    </div>

    <!-- SCROLLABLE CONTENT -->
    <div class="overflow-y-auto pr-2 space-y-5 flex-1 custom-scrollbar">
      <form id="addChallengeForm" class="space-y-5">
        <!-- BASIC INFO -->
        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Title
          </label>
          <input
            type="text"
            name="title"
            required
            minlength="3"
            maxlength="100"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
          />
        </div>

        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Description
          </label>
          <textarea
            name="description"
            rows="3"
            minlength="10"
            maxlength="5000"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
          ></textarea>
        </div>

        <!-- COMMUNITY & STATUS -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Community
            </label>
            <select
              name="community"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="">Select</option>
              <option value="SINGLE">Single</option>
              <option value="MARRIED">Married</option>
              <option value="PARENT">Parent</option>
            </select>
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Status
            </label>
            <select
              name="status"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="ACTIVE">Active</option>
              <option value="DRAFT">Draft</option>
              <option value="ARCHIVED">Archived</option>
            </select>
          </div>
        </div>

        <!-- VISIBILITY & FREQUENCY -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Visibility
            </label>
            <select
              name="visibility"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="PUBLIC">Public</option>
              <option value="COMMUNITY_ONLY">Community Only</option>
            </select>
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Frequency
            </label>
            <select
              name="frequency"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="DAILY">Daily</option>
              <option value="WEEKLY">Weekly</option>
              <option value="MIXED">Mixed</option>
            </select>
          </div>
        </div>

        <!-- DURATION & BADGE -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Duration (days)
            </label>
            <input
              type="number"
              name="durationDays"
              min="1"
              max="365"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            />
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Completion badge code (optional)
            </label>
            <input
              type="text"
              name="completionBadgeCode"
              maxlength="50"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            />
          </div>
        </div>

        <!-- TASKS SECTION -->
        <div class="border-t border-gray-200 pt-4">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-[11px] font-semibold text-gray-800">
              Tasks (at least one)
            </h4>
            <button
              type="button"
              class="text-[11px] px-2 py-1 rounded-lg border border-[var(--color-primary)] text-[var(--color-primary-dark)] hover:bg-[var(--color-secondary-light)]"
              onclick="addTaskItem()"
            >
              + Add Task
            </button>
          </div>

          <div id="taskList" class="space-y-3">
            <!-- Task item template (index 0 by default) -->
            <div
              class="task-item space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-200"
              data-index="0"
            >
              <div class="flex items-center justify-between mb-1">
                <span class="text-[11px] font-semibold text-gray-700">
                  Task <span class="task-label">1</span>
                </span>
                <button
                  type="button"
                  class="text-[10px] px-2 py-1 rounded border border-red-300 text-red-500 hover:bg-red-50 remove-task-btn"
                  onclick="removeTaskItem(this)"
                >
                  Remove
                </button>
              </div>

              <div>
                <label class="block text-[11px] font-medium text-gray-700 mb-1">
                  Task Title
                </label>
                <input
                  type="text"
                  name="tasks[0].title"
                  required
                  minlength="3"
                  maxlength="200"
                  class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
                />
              </div>

              <div>
                <label class="block text-[11px] font-medium text-gray-700 mb-1">
                  Instructions
                </label>
                <textarea
                  name="tasks[0].instructions"
                  rows="2"
                  required
                  minlength="10"
                  maxlength="1000"
                  class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
                ></textarea>
              </div>

              <div class="grid grid-cols-3 gap-2">
                <div>
                  <label
                    class="block text-[11px] font-medium text-gray-700 mb-1"
                  >
                    Day #
                  </label>
                  <input
                    type="number"
                    name="tasks[0].dayNumber"
                    min="1"
                    max="365"
                    class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs"
                  />
                </div>

                <div>
                  <label
                    class="block text-[11px] font-medium text-gray-700 mb-1"
                  >
                    Week #
                  </label>
                  <input
                    type="number"
                    name="tasks[0].weekNumber"
                    min="1"
                    max="52"
                    class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs"
                  />
                </div>

                <div>
                  <label
                    class="block text-[11px] font-medium text-gray-700 mb-1"
                  >
                    Cadence
                  </label>
                  <select
                    name="tasks[0].frequency"
                    required
                    class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
                  >
                    <option value="DAILY">Daily</option>
                    <option value="WEEKLY">Weekly</option>
                  </select>
                </div>
              </div>

              <div>
                <label
                  class="inline-flex items-center gap-2 text-[11px] text-gray-700"
                >
                  <input
                    type="checkbox"
                    name="tasks[0].isMilestone"
                    value="true"
                    class="rounded border-gray-300 text-[var(--color-primary)] focus:ring-[var(--color-primary)]"
                  />
                  Milestone task
                </label>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- FOOTER -->
    <div class="mt-4 flex justify-end gap-2 flex-shrink-0">
      <button
        type="button"
        class="px-3 py-2 rounded-lg border border-gray-300 text-[11px] text-gray-700 hover:bg-gray-50"
        onclick="closeAddChallengeModal()"
      >
        Cancel
      </button>
      <button
        type="submit"
        form="addChallengeForm"
        class="px-3 py-2 rounded-lg bg-[var(--color-primary)] text-[11px] text-white font-semibold hover:bg-[var(--color-primary-dark)]"
      >
        Save
      </button>
    </div>
  </div>
</div>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #c6c6c6;
    border-radius: 10px;
  }
</style>

<script>
  function openAddChallengeModal() {
    const modal = document.getElementById('addChallengeModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeAddChallengeModal() {
    const modal = document.getElementById('addChallengeModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function renumberTaskItems() {
    const taskItems = document.querySelectorAll('#taskList .task-item');

    taskItems.forEach((item, index) => {
      item.dataset.index = index;
      const labelSpan = item.querySelector('.task-label');
      if (labelSpan) labelSpan.textContent = index + 1;

      const fields = item.querySelectorAll(
        'input[name^="tasks["], textarea[name^="tasks["], select[name^="tasks["]',
      );
      fields.forEach((field) => {
        const oldName = field.getAttribute('name');
        if (!oldName) return;
        const newName = oldName.replace(/tasks\[\d+\]/, `tasks[${index}]`);
        field.setAttribute('name', newName);
      });
    });
  }

  function addTaskItem() {
    const container = document.getElementById('taskList');
    const firstItem = container.querySelector('.task-item');
    if (!firstItem) return;

    const clone = firstItem.cloneNode(true);

    // Clear values in cloned inputs
    const inputs = clone.querySelectorAll('input, textarea, select');
    inputs.forEach((el) => {
      if (el.type === 'checkbox') {
        el.checked = false;
      } else if (el.tagName === 'SELECT') {
        el.selectedIndex = 0;
      } else {
        el.value = '';
      }
    });

    container.appendChild(clone);
    renumberTaskItems();
  }

  function removeTaskItem(button) {
    const container = document.getElementById('taskList');
    const items = container.querySelectorAll('.task-item');
    if (items.length <= 1) {
      // If only one task, just clear its fields instead of removing
      const onlyItem = items[0];
      const inputs = onlyItem.querySelectorAll('input, textarea, select');
      inputs.forEach((el) => {
        if (el.type === 'checkbox') {
          el.checked = false;
        } else if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      });
      return;
    }

    const taskItem = button.closest('.task-item');
    if (taskItem) {
      taskItem.remove();
      renumberTaskItems();
    }
  }

  function serializeAddChallengeForm() {
    const form = document.getElementById('addChallengeForm');
    const data = {};

    const getVal = (name) => {
      const el = form.querySelector(`[name="${name}"]`);
      return el ? el.value.trim() : '';
    };

    data.title = getVal('title');
    data.description = getVal('description') || undefined;
    data.community = getVal('community');
    data.status = getVal('status');
    data.visibility = getVal('visibility');
    data.frequency = getVal('frequency');

    const durationDays = parseInt(getVal('durationDays'), 10);
    data.durationDays = isNaN(durationDays) ? undefined : durationDays;

    const badge = getVal('completionBadgeCode');
    data.completionBadgeCode = badge || undefined;

    // Tasks
    const taskItems = document.querySelectorAll('#taskList .task-item');
    const tasks = [];

    taskItems.forEach((item) => {
      const titleEl = item.querySelector('input[name$=".title"]');
      const instructionsEl = item.querySelector(
        'textarea[name$=".instructions"]',
      );
      const dayEl = item.querySelector('input[name$=".dayNumber"]');
      const weekEl = item.querySelector('input[name$=".weekNumber"]');
      const freqEl = item.querySelector('select[name$=".frequency"]');
      const milestoneEl = item.querySelector('input[name$=".isMilestone"]');

      const title = titleEl ? titleEl.value.trim() : '';
      const instructions = instructionsEl ? instructionsEl.value.trim() : '';

      // Skip completely empty tasks (just in case)
      if (!title && !instructions) {
        return;
      }

      const task = {
        title,
        instructions,
        frequency: freqEl ? freqEl.value : 'DAILY', // TaskCadence
      };

      if (dayEl && dayEl.value) {
        const dayNum = parseInt(dayEl.value, 10);
        if (!isNaN(dayNum)) task.dayNumber = dayNum;
      }

      if (weekEl && weekEl.value) {
        const weekNum = parseInt(weekEl.value, 10);
        if (!isNaN(weekNum)) task.weekNumber = weekNum;
      }

      if (milestoneEl && milestoneEl.checked) {
        task.isMilestone = true;
      }

      tasks.push(task);
    });

    data.tasks = tasks;

    return data;
  }

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('addChallengeForm');
    if (!form) return;

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn ? submitBtn.textContent : null;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
      }

      try {
        const payload = serializeAddChallengeForm();

        if (!payload.tasks || payload.tasks.length === 0) {
          alert('Please add at least one task.');
          return;
        }

        // üîÅ Adjust this URL to your actual endpoint
        const res = await fetch('/challenges/create-challenge', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          let msg = 'Failed to create challenge.';
          try {
            const errJson = await res.json();
            if (errJson && errJson.message) {
              msg = Array.isArray(errJson.message)
                ? errJson.message.join('\n')
                : errJson.message;
            }
          } catch (_) {}
          alert(msg);
          return;
        }

        // Success
        closeAddChallengeModal();
        // Reload to see new challenge in table
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'An unexpected error occurred.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    });
  });
</script>
