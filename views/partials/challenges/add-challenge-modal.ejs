<div
  id="addChallengeModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-4"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-6 text-xs overflow-hidden flex flex-col max-h-[90vh]"
    role="dialog"
    aria-modal="true"
    aria-labelledby="addChallengeTitle"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
      <h3 id="addChallengeTitle" class="text-base font-semibold text-gray-800">
        Add Challenge
      </h3>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 text-xl leading-none"
        onclick="closeAddChallengeModal()"
        aria-label="Close modal"
      >
        √ó
      </button>
    </div>

    <!-- SCROLLABLE CONTENT -->
    <div class="overflow-y-auto pr-2 space-y-5 flex-1 custom-scrollbar">
      <form id="addChallengeForm" class="space-y-5">
        <!-- BASIC INFO -->
        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Title
          </label>
          <input
            type="text"
            name="title"
            required
            minlength="3"
            maxlength="100"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
          />
        </div>

        <!-- ‚úÖ NEW: Cover Image Upload -->
        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Cover image (optional)
          </label>
          <input
            type="file"
            name="coverUrl"
            accept="image/png,image/jpeg,image/webp"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
          />
          <p class="text-[11px] text-gray-500 mt-1">PNG, JPG, or WEBP.</p>
        </div>

        <!-- ‚úÖ Description (Rich Text - Quill) -->
        <div>
          <label class="block text-[11px] font-medium text-gray-700 mb-1">
            Description
          </label>

          <div
            id="challengeDescriptionEditor"
            class="bg-white border border-gray-300 rounded-lg"
            style="min-height: 160px"
          ></div>

          <!-- Hidden textarea that gets submitted/serialized -->
          <textarea
            id="challengeDescriptionHtml"
            name="descriptionHtml"
            class="hidden"
          ></textarea>

          <p class="text-[11px] text-gray-500 mt-1">
            Supports formatting, lists, and links.
          </p>
        </div>

        <!-- COMMUNITY & STATUS -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Community
            </label>
            <select
              name="community"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="">Select</option>
              <option value="SINGLE">Single</option>
              <option value="MARRIED">Married</option>
              <option value="PARENT">Parent</option>
            </select>
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Status
            </label>
            <select
              name="status"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="ACTIVE">Active</option>
              <option value="DRAFT">Draft</option>
              <option value="ARCHIVED">Archived</option>
            </select>
          </div>
        </div>

        <!-- VISIBILITY & FREQUENCY -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Visibility
            </label>
            <select
              name="visibility"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="PUBLIC">Public</option>
              <option value="COMMUNITY_ONLY">Community Only</option>
            </select>
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Frequency
            </label>
            <select
              name="frequency"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            >
              <option value="DAILY">Daily</option>
              <option value="WEEKLY">Weekly</option>
              <option value="MIXED">Mixed</option>
            </select>
          </div>
        </div>

        <!-- DURATION & BADGE -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Duration (days)
            </label>
            <input
              type="number"
              name="durationDays"
              min="1"
              max="365"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            />
          </div>

          <div>
            <label class="block text-[11px] font-medium text-gray-700 mb-1">
              Completion badge code (optional)
            </label>
            <input
              type="text"
              name="completionBadgeCode"
              maxlength="50"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
            />
          </div>
        </div>

        <!-- Hidden field to store the final cover URL after upload (backend returns/sets it) -->
        <input type="hidden" name="coverImageUrl" id="coverImageUrl" />
      </form>
    </div>

    <!-- FOOTER -->
    <div class="mt-4 flex justify-end gap-2 flex-shrink-0">
      <button
        type="button"
        class="px-3 py-2 rounded-lg border border-gray-300 text-[11px] text-gray-700 hover:bg-gray-50"
        onclick="closeAddChallengeModal()"
      >
        Cancel
      </button>
      <button
        type="submit"
        form="addChallengeForm"
        class="px-3 py-2 rounded-lg bg-[var(--color-primary)] text-[11px] text-white font-semibold hover:bg-[var(--color-primary-dark)]"
      >
        Save
      </button>
    </div>
  </div>
</div>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #c6c6c6;
    border-radius: 10px;
  }
</style>

<script>
  /* ‚úÖ Quill instance for challenge description */
  let challengeDescriptionQuill;

  function ensureChallengeQuill() {
    if (challengeDescriptionQuill) return;

    const editorEl = document.getElementById('challengeDescriptionEditor');
    if (!editorEl) return;

    challengeDescriptionQuill = new Quill('#challengeDescriptionEditor', {
      theme: 'snow',
      placeholder: 'Write a short description of the challenge...',
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ['bold', 'italic', 'underline'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link'],
          ['clean'],
        ],
      },
    });
  }

  function openAddChallengeModal() {
    const modal = document.getElementById('addChallengeModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    ensureChallengeQuill();
  }

  function closeAddChallengeModal() {
    const modal = document.getElementById('addChallengeModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');

    const form = document.getElementById('addChallengeForm');
    if (form) form.reset();

    if (challengeDescriptionQuill) {
      challengeDescriptionQuill.setContents([]);
    }

    const hidden = document.getElementById('challengeDescriptionHtml');
    if (hidden) hidden.value = '';

    // reset coverImageUrl
    const coverImageUrl = document.getElementById('coverImageUrl');
    if (coverImageUrl) coverImageUrl.value = '';
  }

  function serializeAddChallengeForm() {
    const form = document.getElementById('addChallengeForm');
    const data = {};

    const getVal = (name) => {
      const el = form.querySelector(`[name="${name}"]`);
      return el ? String(el.value || '').trim() : '';
    };

    data.title = getVal('title');
    data.community = getVal('community');
    data.status = getVal('status');
    data.visibility = getVal('visibility');
    data.frequency = getVal('frequency');

    const durationDays = parseInt(getVal('durationDays'), 10);
    data.durationDays = Number.isNaN(durationDays) ? undefined : durationDays;

    const badge = getVal('completionBadgeCode');
    data.completionBadgeCode = badge || undefined;

    // ‚úÖ Quill ‚Üí HTML
    let html = '';
    if (challengeDescriptionQuill) {
      html = challengeDescriptionQuill.root?.innerHTML || '';
      if (html === '<p><br></p>' || html.trim() === '') html = '';
    }

    data.description = html || undefined;
    // data.descriptionHtml = html || undefined;

    // ‚úÖ include coverImageUrl in payload (it will be set by backend or left empty)
    const coverImageUrl = getVal('coverImageUrl');
    data.coverImageUrl = coverImageUrl || undefined;

    return data;
  }

  document.addEventListener('DOMContentLoaded', function () {
    ensureChallengeQuill();

    const form = document.getElementById('addChallengeForm');
    if (!form) return;

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      // ‚úÖ Sync Quill ‚Üí hidden textarea (optional)
      const hidden = document.getElementById('challengeDescriptionHtml');
      if (hidden && challengeDescriptionQuill) {
        let html = challengeDescriptionQuill.root.innerHTML;
        if (html === '<p><br></p>' || html.trim() === '') html = '';
        hidden.value = html;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn ? submitBtn.textContent : null;

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
      }

      try {
        const payload = serializeAddChallengeForm();

        // ‚úÖ Send as multipart/form-data to support coverUrl binary upload
        const formData = new FormData();

        // append payload fields
        Object.entries(payload).forEach(([key, value]) => {
          if (value !== undefined && value !== null && value !== '') {
            formData.append(key, value);
          }
        });

        // append coverUrl binary file
        const fileInput = form.querySelector('input[name="coverUrl"]');
        if (fileInput && fileInput.files && fileInput.files[0]) {
          formData.append('coverUrl', fileInput.files[0]);
        }

        // üîÅ Adjust this URL to your actual endpoint
        const res = await fetch('/challenges/create-challenge', {
          method: 'POST',
          body: formData,
        });

        if (!res.ok) {
          let msg = 'Failed to create challenge.';
          try {
            const errJson = await res.json();
            if (errJson && errJson.message) {
              msg = Array.isArray(errJson.message)
                ? errJson.message.join('\n')
                : errJson.message;
            }
          } catch (_) {}
          alert(msg);
          return;
        }

        closeAddChallengeModal();
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err?.message || 'An unexpected error occurred.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText || 'Save';
        }
      }
    });
  });
</script>
