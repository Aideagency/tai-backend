<!-- Update Counselling Modal (Scrollable + Wider + Mobile friendly) -->
<div
  id="updateCounsellingModal"
  class="fixed inset-0 z-50 hidden bg-black/50 p-3 sm:p-6"
>
  <!-- Backdrop click area + center wrapper -->
  <div class="flex h-full w-full items-center justify-center">
    <!-- Modal panel -->
    <div
      class="w-full max-w-2xl lg:max-w-3xl overflow-hidden rounded-2xl bg-white shadow-xl"
      role="dialog"
      aria-modal="true"
      aria-labelledby="updateCounsellingTitleHeading"
    >
      <!-- ✅ Sticky header -->
      <div
        class="sticky top-0 z-10 flex items-center justify-between border-b border-gray-100 bg-white px-5 py-4"
      >
        <h3
          id="updateCounsellingTitleHeading"
          class="text-base font-semibold text-gray-800"
        >
          Update Counselling Session
        </h3>

        <button
          type="button"
          class="inline-flex h-9 w-9 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700"
          onclick="closeUpdateCounsellingModal()"
          aria-label="Close modal"
        >
          ×
        </button>
      </div>

      <!-- ✅ Scrollable content -->
      <div class="max-h-[80vh] overflow-y-auto px-5 py-4">
        <form
          id="updateCounsellingForm"
          action=""
          method="POST"
          enctype="multipart/form-data"
          class="space-y-3 text-xs"
        >
          <!-- TITLE -->
          <div>
            <label class="block font-medium text-gray-700 mb-1">Title</label>
            <input
              id="updateCounsellingTitle"
              type="text"
              name="title"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
              required
            />
          </div>

          <!-- ✅ DESCRIPTION (Rich Text) -->
          <div>
            <label class="block font-medium text-gray-700 mb-1"
              >Description</label
            >

            <div
              id="updateCounsellingDescriptionEditor"
              class="bg-white border border-gray-300 rounded-lg"
              style="min-height: 140px"
            ></div>

            <textarea
              id="updateCounsellingDescription"
              name="description"
              class="hidden"
            ></textarea>

            <p class="text-[11px] text-gray-500 mt-1">
              Supports formatting, lists, and links.
            </p>
          </div>

          <!-- TYPE + STATUS -->
          <div class="grid grid-cols-1">
            <div>
              <label class="block font-medium text-gray-700 mb-1">Type</label>
              <select
                id="updateCounsellingType"
                name="type"
                class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
              >
                <option value="INDIVIDUAL">Individual</option>
                <option value="COUPLES">Couples</option>
                <option value="FAMILY">Family</option>
                <option value="GROUP">Group</option>
              </select>
            </div>
          </div>

          <!-- MODE + DURATION -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block font-medium text-gray-700 mb-1">Mode</label>
              <select
                id="updateCounsellingMode"
                name="mode"
                class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
              >
                <option value="ONLINE">Online</option>
                <option value="OFFLINE">Offline</option>
              </select>
            </div>

            <div>
              <label class="block font-medium text-gray-700 mb-1">
                Duration (minutes)
              </label>
              <input
                id="updateCounsellingDuration"
                type="number"
                name="durationMinutes"
                min="1"
                class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
              />
            </div>
          </div>

          <!-- PRICE + MAX CLIENTS -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block font-medium text-gray-700 mb-1">
                Price (₦, optional)
              </label>
              <input
                id="updateCounsellingPrice"
                type="number"
                name="price"
                step="0.01"
                class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
              />
            </div>

            <div>
              <label class="block font-medium text-gray-700 mb-1">
                Max clients per session (optional)
              </label>
              <input
                id="updateCounsellingMaxClients"
                type="number"
                name="maxClientsPerSession"
                min="1"
                class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
              />
            </div>
          </div>

          <!-- WHAT YOU GET -->
          <div>
            <label class="block font-medium text-gray-700 mb-1">
              What clients get (optional)
            </label>
            <textarea
              id="updateCounsellingWhatYouGet"
              name="whatYouGet"
              rows="2"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
            ></textarea>
          </div>

          <!-- WHO IT'S FOR -->
          <div>
            <label class="block font-medium text-gray-700 mb-1">
              Who this is for (optional)
            </label>
            <textarea
              id="updateCounsellingWhoItsFor"
              name="whoItsFor"
              rows="2"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
            ></textarea>
          </div>

          <!-- HOW IT WORKS -->
          <div>
            <label class="block font-medium text-gray-700 mb-1">
              How it works (optional)
            </label>
            <textarea
              id="updateCounsellingHowItWorks"
              name="howItWorks"
              rows="2"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
            ></textarea>
          </div>

          <!-- COVER IMAGE -->
          <div>
            <label class="block font-medium text-gray-700 mb-1">
              Cover image (optional)
            </label>

            <input
              id="updateCounsellingCoverImage"
              type="file"
              name="coverUrl"
              accept="image/*"
              class="w-full text-xs text-gray-700 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-[var(--color-primary)] file:text-white hover:file:bg-[var(--color-primary-dark)]"
            />

            <p
              id="updateCounsellingCoverImageInfo"
              class="mt-1 text-[10px] text-gray-500"
            >
              No current cover image.
            </p>

            <img
              id="updateCounsellingCoverImagePreview"
              src=""
              alt="Current cover image"
              class="mt-2 h-20 w-full object-cover rounded-md hidden"
            />
          </div>

          <!-- ✅ Sticky footer actions -->
          <div
            class="sticky bottom-0 z-10 -mx-5 mt-4 border-t border-gray-100 bg-white px-5 py-3"
          >
            <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-2">
              <button
                type="button"
                class="w-full sm:w-auto px-3 py-2 text-xs rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100"
                onclick="closeUpdateCounsellingModal()"
              >
                Cancel
              </button>

              <button
                id="updateCounsellingSubmitBtn"
                type="submit"
                class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 text-xs rounded-md bg-[var(--color-primary)] text-white font-semibold hover:bg-[var(--color-primary-dark)] disabled:opacity-60 disabled:cursor-not-allowed"
              >
                <span id="updateCounsellingSubmitText">Save changes</span>
                <svg
                  id="updateCounsellingSubmitSpinner"
                  class="hidden animate-spin h-4 w-4 text-white"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // ✅ Quill instance for UPDATE description
  let updateCounsellingDescriptionQuill;

  function ensureUpdateCounsellingQuill() {
    if (updateCounsellingDescriptionQuill) return;

    const editorEl = document.getElementById(
      'updateCounsellingDescriptionEditor',
    );
    if (!editorEl) return;

    updateCounsellingDescriptionQuill = new Quill(
      '#updateCounsellingDescriptionEditor',
      {
        theme: 'snow',
        placeholder: 'Update the counselling description...',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            [{ list: 'ordered' }, { list: 'bullet' }],
            ['link'],
            ['clean'],
          ],
        },
      },
    );
  }

  function openUpdateCounsellingModal(btn) {
    const modal = document.getElementById('updateCounsellingModal');
    if (!modal) return;

    ensureUpdateCounsellingQuill();

    const counsellingId = btn.dataset.counsellingId;
    const form = document.getElementById('updateCounsellingForm');

    if (form && counsellingId) {
      form.dataset.counsellingId = counsellingId;
      form.action = '/counselling/update/' + counsellingId;
    }

    // Prefill text/select fields
    document.getElementById('updateCounsellingTitle').value =
      btn.dataset.counsellingTitle || '';
    document.getElementById('updateCounsellingType').value =
      btn.dataset.counsellingType || '';
    document.getElementById('updateCounsellingMode').value =
      btn.dataset.counsellingMode || '';
    document.getElementById('updateCounsellingDuration').value =
      btn.dataset.counsellingDuration || '';
    document.getElementById('updateCounsellingPrice').value =
      btn.dataset.counsellingPrice || '';
    document.getElementById('updateCounsellingMaxClients').value =
      btn.dataset.counsellingMaxClients || '';
    document.getElementById('updateCounsellingWhatYouGet').value =
      btn.dataset.counsellingWhatYouGet || '';
    document.getElementById('updateCounsellingWhoItsFor').value =
      btn.dataset.counsellingWhoItsFor || '';
    document.getElementById('updateCounsellingHowItWorks').value =
      btn.dataset.counsellingHowItWorks || '';

    // ✅ Prefill Quill (expects HTML in dataset)
    const descHtml = btn.dataset.counsellingDescription || '';
    if (updateCounsellingDescriptionQuill) {
      updateCounsellingDescriptionQuill.root.innerHTML =
        descHtml && descHtml.trim() ? descHtml : '';
    }
    const hiddenDesc = document.getElementById('updateCounsellingDescription');
    if (hiddenDesc) hiddenDesc.value = descHtml || '';

    // Booleans
    const isActive =
      btn.dataset.counsellingIsActive === 'true' ||
      btn.dataset.counsellingIsActive === true;
    const isFeatured =
      btn.dataset.counsellingIsFeatured === 'true' ||
      btn.dataset.counsellingIsFeatured === true;

    // Cover image preview
    const coverUrl = btn.dataset.counsellingCoverUrl || '';
    const preview = document.getElementById(
      'updateCounsellingCoverImagePreview',
    );
    const info = document.getElementById('updateCounsellingCoverImageInfo');

    if (coverUrl) {
      preview.src = coverUrl;
      preview.classList.remove('hidden');
      info.textContent = 'Current cover image:';
    } else {
      preview.src = '';
      preview.classList.add('hidden');
      info.textContent = 'No current cover image.';
    }

    modal.classList.remove('hidden');
    modal.classList.add('block');
  }

  function closeUpdateCounsellingModal() {
    const modal = document.getElementById('updateCounsellingModal');
    if (!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('block');

    const form = document.getElementById('updateCounsellingForm');
    if (form) {
      form.reset();
      delete form.dataset.counsellingId;
    }

    if (updateCounsellingDescriptionQuill) {
      updateCounsellingDescriptionQuill.setContents([]);
    }
    const hiddenDesc = document.getElementById('updateCounsellingDescription');
    if (hiddenDesc) hiddenDesc.value = '';

    const btn = document.getElementById('updateCounsellingSubmitBtn');
    const text = document.getElementById('updateCounsellingSubmitText');
    const spinner = document.getElementById('updateCounsellingSubmitSpinner');

    btn.disabled = false;
    spinner.classList.add('hidden');
    text.textContent = 'Save changes';
  }

  document.addEventListener('DOMContentLoaded', () => {
    ensureUpdateCounsellingQuill();

    const form = document.getElementById('updateCounsellingForm');
    if (!form) return;

    const submitBtn = document.getElementById('updateCounsellingSubmitBtn');
    const submitText = document.getElementById('updateCounsellingSubmitText');
    const submitSpinner = document.getElementById(
      'updateCounsellingSubmitSpinner',
    );

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const counsellingId = form.dataset.counsellingId;
      if (!counsellingId) {
        alert('Missing counselling id.');
        return;
      }

      // ✅ Sync Quill → hidden textarea BEFORE FormData
      const descriptionEl = document.getElementById(
        'updateCounsellingDescription',
      );
      if (updateCounsellingDescriptionQuill && descriptionEl) {
        let html = updateCounsellingDescriptionQuill.root.innerHTML;
        if (html === '<p><br></p>' || html.trim() === '') html = '';
        descriptionEl.value = html;
      }

      submitBtn.disabled = true;
      submitSpinner.classList.remove('hidden');
      submitText.textContent = 'Saving...';

      const fd = new FormData();

      fd.append('title', form.title.value);
      fd.append('description', form.description.value || '');
      fd.append('type', form.type.value || '');
      fd.append('mode', form.mode.value || '');

      if (form.durationMinutes.value !== '') {
        fd.append('durationMinutes', form.durationMinutes.value);
      }
      if (form.price.value !== '') {
        fd.append('price', form.price.value);
      }
      if (form.maxClientsPerSession.value !== '') {
        fd.append('maxClientsPerSession', form.maxClientsPerSession.value);
      }
      if (form.whatYouGet.value) fd.append('whatYouGet', form.whatYouGet.value);
      if (form.whoItsFor.value) fd.append('whoItsFor', form.whoItsFor.value);
      if (form.howItWorks.value) fd.append('howItWorks', form.howItWorks.value);

      const coverInput = document.getElementById('updateCounsellingCoverImage');
      if (coverInput && coverInput.files && coverInput.files[0]) {
        fd.append('coverUrl', coverInput.files[0]);
      }

      try {
        const res = await fetch('/counselling/update/' + counsellingId, {
          method: 'PUT',
          credentials: 'include',
          body: fd,
        });

        if (!res.ok) {
          let msg = 'Error updating counselling session.';
          try {
            const data = await res.json();
            msg = Array.isArray(data.message)
              ? data.message.join(', ')
              : data.message || msg;
          } catch (_) {}
          alert(msg);

          submitBtn.disabled = false;
          submitSpinner.classList.add('hidden');
          submitText.textContent = 'Save changes';
          return;
        }

        window.location.reload();
      } catch (err) {
        console.error(err);
        alert('Something went wrong.');

        submitBtn.disabled = false;
        submitSpinner.classList.add('hidden');
        submitText.textContent = 'Save changes';
      }
    });
  });
</script>
