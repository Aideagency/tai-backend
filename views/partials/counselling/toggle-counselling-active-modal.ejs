<div
  id="toggleCounsellingModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40"
>
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-sm p-6">
    <h3 class="text-sm font-semibold text-gray-800 mb-2" id="toggleCounsellingTitleText">
      Toggle Status
    </h3>

    <p class="text-xs text-gray-600 mb-4">
      Are you sure you want to
      <span id="toggleCounsellingActionWord" class="font-semibold"></span>
      the counselling session
      <span id="toggleCounsellingName" class="font-semibold text-[var(--color-primary-dark)]"></span>?
    </p>

    <p class="text-[11px] text-gray-500 mb-2" id="toggleCounsellingHint">
      This will change whether this session is currently available for booking.
    </p>

    <div class="flex justify-end gap-2 mt-4">
      <button
        type="button"
        class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100"
        onclick="closeToggleCounsellingModal()"
      >
        Cancel
      </button>

      <button
        id="confirmToggleCounsellingBtn"
        type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-xs rounded-md bg-[var(--color-primary)] text-white font-semibold hover:bg-[var(--color-primary-dark)] disabled:opacity-60 disabled:cursor-not-allowed"
      >
        <span id="confirmToggleCounsellingText">Confirm</span>

        <!-- Spinner -->
        <svg
          id="confirmToggleCounsellingSpinner"
          class="hidden animate-spin h-4 w-4 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"
          ></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  let selectedToggleCounsellingId = null;
  let selectedToggleCurrentActive = false;

  function openToggleCounsellingModal(btn) {
    const modal = document.getElementById('toggleCounsellingModal');
    if (!modal) return;

    selectedToggleCounsellingId = btn.dataset.counsellingId;
    selectedToggleCurrentActive =
      btn.dataset.counsellingIsActive === 'true' ||
      btn.dataset.counsellingIsActive === true;

    const title = btn.dataset.counsellingTitle || '';

    const nameSpan = document.getElementById('toggleCounsellingName');
    const actionWordSpan = document.getElementById('toggleCounsellingActionWord');
    const headerText = document.getElementById('toggleCounsellingTitleText');
    const hintText = document.getElementById('toggleCounsellingHint');
    const confirmBtnText = document.getElementById('confirmToggleCounsellingText');

    if (nameSpan) nameSpan.textContent = title;

    const nextAction = selectedToggleCurrentActive ? 'deactivate' : 'activate';

    if (actionWordSpan) {
      actionWordSpan.textContent = nextAction;
      actionWordSpan.classList.toggle('text-red-600', selectedToggleCurrentActive);
      actionWordSpan.classList.toggle('text-emerald-600', !selectedToggleCurrentActive);
    }

    if (headerText) {
      headerText.textContent = selectedToggleCurrentActive
        ? 'Deactivate Counselling Session'
        : 'Activate Counselling Session';
    }

    if (hintText) {
      hintText.textContent = selectedToggleCurrentActive
        ? 'Clients will no longer be able to book this session once deactivated.'
        : 'Clients will be able to see and book this session once activated.';
    }

    if (confirmBtnText) {
      confirmBtnText.textContent = selectedToggleCurrentActive ? 'Deactivate' : 'Activate';
    }

    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeToggleCounsellingModal() {
    const modal = document.getElementById('toggleCounsellingModal');
    if (!modal) return;

    modal.classList.add('hidden');
    modal.classList.remove('flex');
    selectedToggleCounsellingId = null;

    const btn = document.getElementById('confirmToggleCounsellingBtn');
    const text = document.getElementById('confirmToggleCounsellingText');
    const spinner = document.getElementById('confirmToggleCounsellingSpinner');

    if (btn && text && spinner) {
      btn.disabled = false;
      spinner.classList.add('hidden');
      text.textContent = 'Confirm';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('confirmToggleCounsellingBtn');
    const text = document.getElementById('confirmToggleCounsellingText');
    const spinner = document.getElementById('confirmToggleCounsellingSpinner');

    if (!btn) return;

    btn.addEventListener('click', async () => {
      if (!selectedToggleCounsellingId) return;

      try {
        btn.disabled = true;
        spinner.classList.remove('hidden');
        text.textContent = selectedToggleCurrentActive ? 'Deactivating...' : 'Activating...';

        // Adjust to your route â€” this matches the CounsellingController we sketched:
        // @Patch('toggle-active/:id')
        const res = await fetch(
          `/counselling/toggle-active/${selectedToggleCounsellingId}`,
          {
            method: 'PATCH',
            credentials: 'include',
          },
        );

        if (!res.ok) {
          btn.disabled = false;
          spinner.classList.add('hidden');
          text.textContent = selectedToggleCurrentActive ? 'Deactivate' : 'Activate';
          alert('Error updating counselling status.');
          return;
        }

        window.location.reload();
      } catch (err) {
        console.error(err);
        btn.disabled = false;
        spinner.classList.add('hidden');
        text.textContent = selectedToggleCurrentActive ? 'Deactivate' : 'Activate';
        alert('Something went wrong.');
      }
    });
  });
</script>
