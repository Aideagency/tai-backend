<!-- Preview Counselling Modal (Rich Text HTML support) -->
<div
  id="previewCounsellingModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40"
>
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-lg p-6 text-xs">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold text-gray-800">Counselling Preview</h3>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 text-lg leading-none"
        onclick="closePreviewCounsellingModal()"
      >
        ×
      </button>
    </div>

    <!-- CONTENT -->
    <div id="previewCounsellingContent" class="space-y-3">
      <!-- Basic info -->
      <div>
        <p
          class="font-semibold text-gray-800 text-sm"
          id="previewCounsellingTitle"
        ></p>

        <!-- ✅ Rich text container (renders HTML) -->
        <div
          class="text-[11px] text-gray-600 leading-relaxed space-y-2"
          id="previewCounsellingDescription"
        ></div>
      </div>

      <!-- Cover image (optional) -->
      <div>
        <span class="text-[10px] text-gray-500 block mb-1">Cover image</span>
        <img
          id="previewCounsellingCoverImage"
          src=""
          alt="Cover image"
          class="h-24 w-full object-cover rounded-md hidden"
        />
        <p
          id="previewCounsellingCoverImageInfo"
          class="text-[10px] text-gray-500"
        >
          No cover image.
        </p>
      </div>

      <!-- Tags / meta -->
      <div class="grid grid-cols-2 gap-2">
        <div>
          <span class="text-[10px] text-gray-500">Type</span>
          <p class="text-[11px] font-medium" id="previewCounsellingType"></p>
        </div>
        <div>
          <span class="text-[10px] text-gray-500">Status</span>
          <p class="text-[11px] font-medium" id="previewCounsellingStatus"></p>
        </div>
        <div>
          <span class="text-[10px] text-gray-500">Mode</span>
          <p class="text-[11px] font-medium" id="previewCounsellingMode"></p>
        </div>
        <div>
          <span class="text-[10px] text-gray-500">Duration</span>
          <p
            class="text-[11px] font-medium"
            id="previewCounsellingDuration"
          ></p>
        </div>
      </div>

      <!-- Price + max clients -->
      <div class="grid grid-cols-2 gap-2">
        <div>
          <span class="text-[10px] text-gray-500">Price</span>
          <p class="text-[11px]" id="previewCounsellingPrice"></p>
        </div>
        <div>
          <span class="text-[10px] text-gray-500">Max clients per session</span>
          <p class="text-[11px]" id="previewCounsellingMaxClients"></p>
        </div>
      </div>

      <!-- Active / Featured -->
      <div class="grid grid-cols-2 gap-2">
        <div>
          <span class="text-[10px] text-gray-500">Active</span>
          <p
            class="text-[11px] font-medium"
            id="previewCounsellingIsActive"
          ></p>
        </div>
        <div>
          <span class="text-[10px] text-gray-500">Featured</span>
          <p
            class="text-[11px] font-medium"
            id="previewCounsellingIsFeatured"
          ></p>
        </div>
      </div>

      <!-- What you get -->
      <div>
        <span class="text-[10px] text-gray-500">What clients get</span>
        <div
          class="text-[11px] text-gray-700 leading-relaxed space-y-2"
          id="previewCounsellingWhatYouGet"
        ></div>
      </div>

      <!-- Who it's for -->
      <div>
        <span class="text-[10px] text-gray-500">Who this is for</span>
        <div
          class="text-[11px] text-gray-700 leading-relaxed space-y-2"
          id="previewCounsellingWhoItsFor"
        ></div>
      </div>

      <!-- How it works -->
      <div>
        <span class="text-[10px] text-gray-500">How it works</span>
        <div
          class="text-[11px] text-gray-700 leading-relaxed space-y-2"
          id="previewCounsellingHowItWorks"
        ></div>
      </div>
    </div>

    <!-- Simple loading state -->
    <div
      id="previewCounsellingLoading"
      class="hidden text-[11px] text-gray-500 text-center py-4"
    >
      Loading counselling details...
    </div>

    <div class="mt-4 flex justify-end">
      <button
        type="button"
        class="px-4 py-1.5 text-xs rounded-md bg-[var(--color-primary)] text-white font-semibold hover:bg-[var(--color-primary-dark)]"
        onclick="closePreviewCounsellingModal()"
      >
        Close
      </button>
    </div>
  </div>
</div>

<script>
  function setPreviewCounsellingLoading(isLoading) {
    const content = document.getElementById('previewCounsellingContent');
    const loading = document.getElementById('previewCounsellingLoading');

    if (!content || !loading) return;

    if (isLoading) {
      content.classList.add('hidden');
      loading.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      loading.classList.add('hidden');
    }
  }

  // ✅ Basic allowlist HTML sanitizer (lightweight fallback).
  // If you can, use DOMPurify for production.
  function sanitizeHtml(html = '') {
    const template = document.createElement('template');
    template.innerHTML = html;

    const allowedTags = new Set([
      'P',
      'BR',
      'B',
      'STRONG',
      'I',
      'EM',
      'U',
      'UL',
      'OL',
      'LI',
      'A',
      'H1',
      'H2',
      'H3',
      'H4',
      'H5',
      'H6',
      'BLOCKQUOTE',
      'SPAN',
    ]);

    const allowedAttrs = {
      A: new Set(['href', 'target', 'rel']),
      SPAN: new Set(['style']),
    };

    const walker = document.createTreeWalker(
      template.content,
      NodeFilter.SHOW_ELEMENT,
      null,
    );

    const nodesToRemove = [];
    while (walker.nextNode()) {
      const el = walker.currentNode;

      // Unwrap disallowed tags
      if (!allowedTags.has(el.tagName)) {
        nodesToRemove.push(el);
        continue;
      }

      // Remove disallowed attributes
      [...el.attributes].forEach((attr) => {
        const name = attr.name;
        const lower = name.toLowerCase();
        const tag = el.tagName;

        const isAllowed =
          (allowedAttrs[tag] && allowedAttrs[tag].has(name)) ||
          (tag === 'A' && allowedAttrs.A.has(name)) ||
          (tag === 'SPAN' && allowedAttrs.SPAN.has(name));

        const allowClass = lower === 'class'; // keep Quill classes if any

        if (!isAllowed && !allowClass) {
          el.removeAttribute(name);
        }
      });

      // Remove inline JS handlers + javascript/data URLs
      [...el.attributes].forEach((attr) => {
        const lower = attr.name.toLowerCase();

        if (lower.startsWith('on')) el.removeAttribute(attr.name);

        if (el.tagName === 'A' && lower === 'href') {
          const href = (el.getAttribute('href') || '').trim();
          const bad = href.startsWith('javascript:') || href.startsWith('data:');
          if (bad) el.removeAttribute('href');
        }
      });

      // Safe link behavior
      if (el.tagName === 'A') {
        el.setAttribute('target', '_blank');
        el.setAttribute('rel', 'noopener noreferrer');
      }
    }

    // unwrap nodes (keep their children)
    nodesToRemove.forEach((node) => {
      const parent = node.parentNode;
      if (!parent) return;
      while (node.firstChild) parent.insertBefore(node.firstChild, node);
      parent.removeChild(node);
    });

    return template.innerHTML;
  }

  function setRichText(el, html) {
    if (!el) return;

    const safe = sanitizeHtml(html || '');
    el.innerHTML =
      safe && safe.trim()
        ? safe
        : '<span class="text-gray-500">-</span>';
  }

  async function openPreviewCounsellingModal(btn) {
    const modal = document.getElementById('previewCounsellingModal');
    if (!modal) return;

    const counsellingId = btn.dataset.counsellingId;
    if (!counsellingId) {
      console.error('Missing data-counselling-id on preview button');
      return;
    }

    // Show modal + loading state
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setPreviewCounsellingLoading(true);

    try {
      // Adjust this route to match your CounsellingController
      const res = await fetch(`/counselling/admin/${counsellingId}`, {
        method: 'GET',
        credentials: 'include',
      });

      if (!res.ok) {
        console.error('Failed to fetch counselling details', res.status);
        setPreviewCounsellingLoading(false);
        document.getElementById('previewCounsellingTitle').textContent =
          'Error loading counselling session';
        return;
      }

      const c = await res.json();
      setPreviewCounsellingLoading(false);

      // Basic info
      document.getElementById('previewCounsellingTitle').textContent =
        c.title || '-';

      // ✅ Render rich text HTML
      setRichText(
        document.getElementById('previewCounsellingDescription'),
        c.description,
      );

      // Cover image
      const coverImg = document.getElementById('previewCounsellingCoverImage');
      const coverInfo = document.getElementById(
        'previewCounsellingCoverImageInfo',
      );

      if (c.coverUrl) {
        coverImg.src = c.coverUrl;
        coverImg.classList.remove('hidden');
        coverInfo.textContent = 'Current cover image:';
      } else {
        coverImg.src = '';
        coverImg.classList.add('hidden');
        coverInfo.textContent = 'No cover image.';
      }

      // Meta
      document.getElementById('previewCounsellingType').textContent =
        c.type || '-';
      document.getElementById('previewCounsellingStatus').textContent =
        c.status || '-';
      document.getElementById('previewCounsellingMode').textContent =
        c.mode || '-';

      // Duration
      document.getElementById('previewCounsellingDuration').textContent =
        c.durationMinutes ? `${c.durationMinutes} min` : '-';

      // Price
      const priceEl = document.getElementById('previewCounsellingPrice');
      if (c.price === null || c.price === undefined || Number(c.price) === 0) {
        priceEl.textContent = 'Free';
      } else {
        priceEl.textContent = `₦${c.price}`;
      }

      // Max clients
      document.getElementById('previewCounsellingMaxClients').textContent =
        c.maxClientsPerSession ?? '-';

      // Booleans
      document.getElementById('previewCounsellingIsActive').textContent =
        c.isActive ? 'Yes' : 'No';
      document.getElementById('previewCounsellingIsFeatured').textContent =
        c.isFeatured ? 'Yes' : 'No';

      // ✅ Optional sections: render as rich text too (in case they contain HTML)
      setRichText(
        document.getElementById('previewCounsellingWhatYouGet'),
        c.whatYouGet,
      );
      setRichText(
        document.getElementById('previewCounsellingWhoItsFor'),
        c.whoItsFor,
      );
      setRichText(
        document.getElementById('previewCounsellingHowItWorks'),
        c.howItWorks,
      );
    } catch (err) {
      console.error(err);
      setPreviewCounsellingLoading(false);
      document.getElementById('previewCounsellingTitle').textContent =
        'Error loading counselling session';
    }
  }

  function closePreviewCounsellingModal() {
    const modal = document.getElementById('previewCounsellingModal');
    if (!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
</script>
