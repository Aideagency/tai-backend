<!-- views/admin/partials/delete-modal.ejs -->

<!-- Delete Confirmation Modal -->
<div
  id="deleteModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40"
>
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-sm p-6">
    <h3 class="text-sm font-semibold text-gray-800 mb-2">Confirm Delete</h3>
    <p class="text-xs text-gray-600 mb-4">
      Are you sure you want to delete
      <span id="deleteUserName" class="font-semibold text-red-600"></span>? This
      action cannot be undone.
    </p>

    <div class="flex justify-end gap-2 mt-4">
      <button
        type="button"
        class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100"
        onclick="closeDeleteModal()"
      >
        Cancel
      </button>

      <button
        id="confirmDeleteBtn"
        type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-xs rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed"
      >
        <span id="confirmDeleteText">Delete</span>

        <!-- Spinner -->
        <svg
          id="confirmDeleteSpinner"
          class="hidden animate-spin h-4 w-4 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"
          ></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  let selectedUserId = null;

  function openDeleteModal(button) {
    selectedUserId = button.getAttribute('data-user-id');
    const userName = button.getAttribute('data-user-name');

    document.getElementById('deleteUserName').textContent = userName;

    const modal = document.getElementById('deleteModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    selectedUserId = null;

    // Reset button state if needed
    const btn = document.getElementById('confirmDeleteBtn');
    const text = document.getElementById('confirmDeleteText');
    const spinner = document.getElementById('confirmDeleteSpinner');

    btn.disabled = false;
    spinner.classList.add('hidden');
    text.textContent = 'Delete';
  }

  const confirmBtn = document.getElementById('confirmDeleteBtn');
  const confirmText = document.getElementById('confirmDeleteText');
  const confirmSpinner = document.getElementById('confirmDeleteSpinner');

  confirmBtn.addEventListener('click', async () => {
    if (!selectedUserId) return;

    try {
      // UI: show loader, disable button
      confirmBtn.disabled = true;
      confirmSpinner.classList.remove('hidden');
      confirmText.textContent = 'Deleting...';

      const res = await fetch(`/admin/users/${selectedUserId}`, {
        method: 'DELETE',
        credentials: 'include', // send admin_token cookie
      });

      if (!res.ok) {
        confirmBtn.disabled = false;
        confirmSpinner.classList.add('hidden');
        confirmText.textContent = 'Delete';
        alert('Error deleting user.');
        return;
      }

      // success â†’ reload page
      window.location.reload();
    } catch (error) {
      console.error(error);
      confirmBtn.disabled = false;
      confirmSpinner.classList.add('hidden');
      confirmText.textContent = 'Delete';
      alert('Something went wrong.');
    }
  });
</script>
