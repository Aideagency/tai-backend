<!-- Preview Book Modal -->
<div
  id="previewBookModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40"
>
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-lg p-6 text-xs">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold text-gray-800">Book Preview</h3>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 text-lg leading-none"
        onclick="closePreviewBookModal()"
      >
        Ã—
      </button>
    </div>

    <div id="previewBookContent" class="space-y-3">
      <!-- Header -->
      <div class="flex gap-3">
        <img
          id="previewBookCover"
          src=""
          alt="Book cover"
          class="w-20 h-24 rounded-lg object-cover border border-gray-200 bg-gray-50"
        />

        <div class="min-w-0">
          <p
            class="font-semibold text-gray-800 text-sm"
            id="previewBookTitle"
          ></p>
          <p class="text-[11px] text-gray-600">
            By <span id="previewBookAuthor" class="font-medium"></span>
          </p>

          <!-- HTML-rendered description -->
          <div
            id="previewBookDescription"
            class="mt-1 text-[11px] text-gray-600 leading-relaxed max-w-none space-y-1 [&_p]:my-1 [&_ul]:list-disc [&_ul]:pl-4 [&_ul]:my-1 [&_ol]:list-decimal [&_ol]:pl-4 [&_ol]:my-1 [&_li]:my-0 [&_a]:text-[var(--color-primary-dark)] [&_a]:underline [&_strong]:font-semibold [&_b]:font-semibold [&_em]:italic [&_blockquote]:border-l-2 [&_blockquote]:pl-2 [&_blockquote]:text-gray-500"
          ></div>
        </div>
      </div>

      <!-- Meta -->
      <div class="grid grid-cols-2 gap-2">
        <div>
          <span class="text-[10px] text-gray-500">Ownership</span>
          <p class="text-[11px] font-medium" id="previewBookOwnershipType"></p>
        </div>

        <div>
          <span class="text-[10px] text-gray-500">Access</span>
          <p class="text-[11px] font-medium" id="previewBookAccessType"></p>
        </div>

        <div>
          <span class="text-[10px] text-gray-500">Published</span>
          <p class="text-[11px] font-medium" id="previewBookPublished"></p>
        </div>

        <div>
          <span class="text-[10px] text-gray-500">Currency</span>
          <p class="text-[11px] font-medium" id="previewBookCurrency"></p>
        </div>
      </div>

      <!-- Price -->
      <div>
        <span class="text-[10px] text-gray-500">Price</span>
        <p class="text-[11px]" id="previewBookPrice"></p>
      </div>

      <!-- Links -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div>
          <span class="text-[10px] text-gray-500">External URL</span>
          <a
            id="previewBookExternalUrl"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="text-[10px] text-[var(--color-primary-dark)] underline break-all"
          >
            N/A
          </a>
        </div>

        <div>
          <span class="text-[10px] text-gray-500">PDF URL</span>
          <a
            id="previewBookPdfUrl"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="text-[10px] text-[var(--color-primary-dark)] underline break-all"
          >
            N/A
          </a>
        </div>
      </div>

      <!-- Downloads -->
      <div class="border-t pt-3 mt-2">
        <span class="text-[10px] text-gray-500 block mb-1">Downloads</span>
        <div class="grid grid-cols-2 gap-2">
          <p class="text-[11px]">
            Total:
            <span id="previewBookTotalDownloads" class="font-medium"></span>
          </p>
          <p class="text-[11px]">
            Active:
            <span id="previewBookActiveDownloads" class="font-medium"></span>
          </p>
        </div>
      </div>

      <!-- Dates -->
      <div class="grid grid-cols-2 gap-2">
        <div>
          <span class="text-[10px] text-gray-500">Created</span>
          <p class="text-[11px]" id="previewBookCreatedAt"></p>
        </div>
        <div>
          <span class="text-[10px] text-gray-500">Updated</span>
          <p class="text-[11px]" id="previewBookUpdatedAt"></p>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div
      id="previewBookLoading"
      class="hidden text-[11px] text-gray-500 text-center py-4"
    >
      Loading book details...
    </div>

    <div class="mt-4 flex justify-end">
      <button
        type="button"
        class="px-4 py-1.5 text-xs rounded-md bg-[var(--color-primary)] text-white font-semibold hover:bg-[var(--color-primary-dark)]"
        onclick="closePreviewBookModal()"
      >
        Close
      </button>
    </div>
  </div>
</div>

<script>
  /* ---------- SAFE HTML SANITIZER ---------- */
  function sanitizeHtml(inputHtml = '') {
    const ALLOWED_TAGS = new Set([
      'B',
      'STRONG',
      'I',
      'EM',
      'U',
      'BR',
      'P',
      'DIV',
      'SPAN',
      'UL',
      'OL',
      'LI',
      'H1',
      'H2',
      'H3',
      'H4',
      'H5',
      'H6',
      'BLOCKQUOTE',
      'CODE',
      'PRE',
      'A',
    ]);

    const ALLOWED_ATTR = {
      A: new Set(['href', 'target', 'rel']),
    };

    const template = document.createElement('template');
    template.innerHTML = String(inputHtml || '');

    const walk = (node) => {
      if (node.nodeType === Node.COMMENT_NODE) {
        node.remove();
        return;
      }

      if (node.nodeType === Node.ELEMENT_NODE) {
        const tag = node.tagName;

        if (!ALLOWED_TAGS.has(tag)) {
          node.replaceWith(document.createTextNode(node.textContent || ''));
          return;
        }

        [...node.attributes].forEach((attr) => {
          const name = attr.name.toLowerCase();
          const value = attr.value;

          if (name.startsWith('on')) node.removeAttribute(attr.name);

          const allowed = ALLOWED_ATTR[tag];
          if (!allowed || !allowed.has(attr.name))
            node.removeAttribute(attr.name);

          if (
            tag === 'A' &&
            name === 'href' &&
            /^(javascript|data):/i.test(value)
          ) {
            node.removeAttribute('href');
          }
        });

        if (tag === 'A') {
          node.setAttribute('target', '_blank');
          node.setAttribute('rel', 'noopener noreferrer');
        }
      }

      [...node.childNodes].forEach(walk);
    };

    walk(template.content);
    return template.innerHTML;
  }

  function renderHtml(el, html) {
    if (!el) return;
    const hasHtml = /<\/?[a-z][\s\S]*>/i.test(html || '');
    const content = hasHtml
      ? html
      : String(html || '').replace(/\n/g, '<br />');
    el.innerHTML = sanitizeHtml(content) || '-';
  }

  /* ---------- UTILITIES ---------- */
  function setPreviewBookLoading(isLoading) {
    const content = document.getElementById('previewBookContent');
    const loading = document.getElementById('previewBookLoading');
    if (!content || !loading) return;
    content.classList.toggle('hidden', isLoading);
    loading.classList.toggle('hidden', !isLoading);
  }

  function formatDateTime(value) {
    if (!value) return '-';
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleString('en-US', {
      day: 'numeric',
      month: 'long',
      year: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true,
    });
  }

  function money(value, currency) {
    if (value == null) return '-';
    return `${currency || ''} ${Number(value).toLocaleString()}`.trim();
  }

  /* ---------- MAIN ---------- */
  async function openPreviewBookModal(btn) {
    const modal = document.getElementById('previewBookModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setPreviewBookLoading(true);

    const res = await fetch(`/admin/books/${btn.dataset.bookId}`, {
      credentials: 'include',
    });

    const json = await res.json();
    const book = json?.data?.book || {};
    const stats = json?.data?.downloadStats || {};

    setPreviewBookLoading(false);

    const img = document.getElementById('previewBookCover');
    if (img && book?.coverImageUrl) {
      img.src = book.coverImageUrl;
    }

    document.getElementById('previewBookTitle').textContent = book.title || '-';
    document.getElementById('previewBookAuthor').textContent =
      book.author || '-';

    renderHtml(
      document.getElementById('previewBookDescription'),
      book.description,
    );

    document.getElementById('previewBookOwnershipType').textContent =
      book.ownershipType || '-';
    document.getElementById('previewBookAccessType').textContent =
      book.accessType || '-';
    document.getElementById('previewBookPublished').textContent =
      book.isPublished ? 'Yes' : 'No';
    document.getElementById('previewBookCurrency').textContent =
      book.currency || '-';

    document.getElementById('previewBookPrice').textContent =
      book.accessType === 'FREE' ? 'Free' : money(book.price, book.currency);

    document.getElementById('previewBookExternalUrl').textContent =
      book.externalUrl || 'N/A';
    document.getElementById('previewBookExternalUrl').href =
      book.externalUrl || '#';

    document.getElementById('previewBookPdfUrl').textContent = book.pdfUrl
      ? 'Open PDF'
      : 'N/A';
    document.getElementById('previewBookPdfUrl').href = book.pdfUrl || '#';

    document.getElementById('previewBookTotalDownloads').textContent =
      stats.total ?? 0;
    document.getElementById('previewBookActiveDownloads').textContent =
      stats.active ?? 0;

    document.getElementById('previewBookCreatedAt').textContent =
      formatDateTime(book.createdAt);
    document.getElementById('previewBookUpdatedAt').textContent =
      formatDateTime(book.updatedAt);
  }

  function closePreviewBookModal() {
    const modal = document.getElementById('previewBookModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
</script>
